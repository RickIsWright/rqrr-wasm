<video id="video" autoplay>
</video>
 
<button id="capture">Capture</button>
 
<div id="output"></div>
<script src="qr_rust.js"></script>
<script>
  const constraints = {
    video: true
  };
  var video, $output;
  var scale = 0.25;

  var decodeQr = function(byteArray) {
    const { decode_qr } = wasm_bindgen;

    wasm_bindgen('qr_rust.wasm').then(() => {
      decode_qr(byteArray);
    }).catch(console.error)
  }

  var captureImage = function() {
    console.log('captured! 1');
    var canvas = document.createElement("canvas");
    canvas.width = video.videoWidth * scale;
    canvas.height = video.videoHeight * scale;
    canvas.getContext("2d").drawImage(video, 0, 0, canvas.width, canvas.height);
    console.log('captured! 1');

    var img = document.createElement("img");
    window.myCanvas = canvas;
    img.src = canvas.toDataURL();
    $output.appendChild(img);
    console.log('captured!');

    const theByteArray = myCanvas.getContext("2d").getImageData(0, 0, 640, 480).data; // we will send this wasm
    decodeQr(theByteArray);
  };
  
  var initialize = function() {
    $output = document.getElementById("output");
    video = document.getElementById("video");

    navigator.mediaDevices.getUserMedia(constraints).then(stream => {
      video.srcObject = stream;
    });
    const capture = document.getElementById("capture");
    
    console.log({ capture });

    capture.addEventListener("click", captureImage);
    console.log("initialized");
  };

  initialize();
</script>